{% extends 'base.html' %}
{% load form_extras %}
{% block content %}
<div class="row mt-2 centerify">
  <div class="col s12">
    <div class="card">
      <div class="card-content">
        <span class="card-title">
          <i class="material-icons left">add_circle</i>Nuovo Ticket
        </span>

        <form method="post" enctype="multipart/form-data" class="row" novalidate>
          {% csrf_token %}
          {{ form.non_field_errors }}

          <!-- Titolo -->
          <div class="input-field col s12">
            {{ form.title.label_tag }}
            {{ form.title }}
            {% for e in form.title.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <!-- Descrizione -->
          <div class="input-field col s12">
            {{ form.description.label_tag }}
            {{ form.description }}
            {% for e in form.description.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <!-- Reparto -->
          <div class="input-field col s12 m6">
            {{ form.department|add_class:"browser-default" }}
            <label class="active">{{ form.department.label }}</label>
            {% for e in form.department.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <!-- Priorità/Impatto/Urgenza -->
          <div class="input-field col s12 m6">
            {{ form.priority|add_class:"browser-default" }}
            <label class="active">{{ form.priority.label }}</label>
            {% for e in form.priority.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>
          <div class="input-field col s12 m6">
            {{ form.impact|add_class:"browser-default" }}
            <label class="active">{{ form.impact.label }}</label>
            {% for e in form.impact.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>
          <div class="input-field col s12 m6">
            {{ form.urgency|add_class:"browser-default" }}
            <label class="active">{{ form.urgency.label }}</label>
            {% for e in form.urgency.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          {% if form.source_channel %}
          <div class="input-field col s12 m6">
            {{ form.source_channel|add_class:"browser-default" }}
            <label class="active">{{ form.source_channel.label }}</label>
            {% for e in form.source_channel.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>
          {% endif %}

          <!-- Location / Asset -->
          <div class="input-field col s12 m6">
            {{ form.location.label_tag }} {{ form.location }}
            {% for e in form.location.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>
          <div class="input-field col s12 m6">
            {{ form.asset_code.label_tag }} {{ form.asset_code }}
            {% for e in form.asset_code.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <!-- ===== CATEGORIE PER REPARTO ===== -->
          <div class="col s12">
            <h6 class="grey-text text-darken-1" style="margin-top: .5rem;">Categoria (se prevista dal reparto)</h6>
          </div>

          <!-- ICT -->
          <div class="input-field col s12 m6 category-select" data-dep="ICT" style="display:none;">
            <label class="active">Categoria (ICT)</label>
            <select id="id_category_ict" class="browser-default" disabled>
              <option value="">— seleziona —</option>
              {% for val,label in ICT_CATEGORY_CHOICES %}
                <option value="{{ val }}" {% if form.category.value == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- WH -->
          <div class="input-field col s12 m6 category-select" data-dep="WH" style="display:none;">
            <label class="active">Categoria (Magazzino)</label>
            <select id="id_category_wh" class="browser-default" disabled>
              <option value="">— seleziona —</option>
              {% for val,label in WH_CATEGORY_CHOICES %}
                <option value="{{ val }}" {% if form.category.value == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- SP -->
          <div class="input-field col s12 m6 category-select" data-dep="SP" style="display:none;">
            <label class="active">Categoria (Piano turni)</label>
            <select id="id_category_sp" class="browser-default" disabled>
              <option value="">— seleziona —</option>
              {% for val,label in SP_CATEGORY_CHOICES %}
                <option value="{{ val }}" {% if form.category.value == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Campo nascosto/visibile che invia davvero la categoria -->
          <input type="hidden" name="category" id="id_category_real" value="{{ form.category.value|default_if_none:'' }}"/>

          <!-- Altro (dettaglio) -->
          <div class="input-field col s12 m6" id="category_other_wrap" style="display:none;">
            {{ form.category_other.label_tag }}
            {{ form.category_other }}
            {% for e in form.category_other.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <!-- Allegati -->
          <div class="col s12 m6">
            <div class="file-field input-field">
              <div class="btn blue darken-3">
                <span><i class="material-icons left">attach_file</i>Allega</span>
                <input type="file" id="id_attachments" name="attachments" multiple>
              </div>
              <div class="file-path-wrapper">
                <input class="file-path validate" type="text" placeholder="PDF/JPG/PNG/XLSX/DOCX/TXT, max 15MB ciascuno">
              </div>
            </div>
            {% for e in form.attachments.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
            <small class="grey-text">
              Formati consentiti: pdf, jpg, jpeg, png, xlsx, docx, txt.
            </small>
          </div>

          <!-- Azioni -->
          <div class="col s12">
            <div class="row" style="margin-bottom:0;">
              <div class="col s12 m6">
                <a href="{% url 'landing' %}" class="btn-flat btn-flat-primary">
                  <i class="material-icons left">arrow_back</i>Annulla
                </a>
              </div>
              <div class="col s12 m6 right-align">
                <button class="btn waves-effect waves-light blue darken-3 btn-full-sm" type="submit">
                  Crea Ticket <i class="material-icons right">send</i>
                </button>
              </div>
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const depSelect = document.getElementById("id_department");
  const catReal   = document.getElementById("id_category_real");
  const otherWrap = document.getElementById("category_other_wrap");
  const OTHER_CODE = "{{ OTHER_CODE }}";

  // mapping dep_id -> codice dep
  const ICT_ID = {{ ict_dep_id|default:"null" }};
  const WH_ID  = {{ wh_dep_id|default:"null" }};
  const SP_ID  = {{ sp_dep_id|default:"null" }};

  // selettori per categoria per reparto
  const selICT = document.getElementById("id_category_ict");
  const selWH  = document.getElementById("id_category_wh");
  const selSP  = document.getElementById("id_category_sp");

  function activeSelectForDepartment(depId) {
    // nascondi/disable tutto
    [selICT, selWH, selSP].forEach(sel => {
      sel.closest(".category-select").style.display = "none";
      sel.disabled = true;
    });

    let active = null;
    if (depId && ICT_ID && depId.toString() === ICT_ID.toString()) {
      active = selICT;
    } else if (depId && WH_ID && depId.toString() === WH_ID.toString()) {
      active = selWH;
    } else if (depId && SP_ID && depId.toString() === SP_ID.toString()) {
      active = selSP;
    }

    if (active) {
      active.closest(".category-select").style.display = "";
      active.disabled = false;
    }
    return active;
  }

  function syncCategoryToHidden(activeSel) {
    if (!activeSel || activeSel.disabled) {
      catReal.value = "";
      otherWrap.style.display = "none";
      return;
    }
    catReal.value = activeSel.value || "";
    otherWrap.style.display = (activeSel.value === OTHER_CODE) ? "" : "none";
  }

  // on load
  const currentDepId = depSelect ? depSelect.value : null;
  const activeSelOnLoad = activeSelectForDepartment(currentDepId);
  // ripristina eventuale categoria selezionata dal server
  if (activeSelOnLoad && catReal.value) {
    activeSelOnLoad.value = catReal.value;
  }
  syncCategoryToHidden(activeSelOnLoad);

  // eventi
  if (depSelect) {
    depSelect.addEventListener("change", function() {
      const active = activeSelectForDepartment(this.value);
      // reset categoria quando cambio reparto
      if (active) active.value = "";
      syncCategoryToHidden(active);
    });
  }

  [selICT, selWH, selSP].forEach(sel => {
    sel.addEventListener("change", function() {
      syncCategoryToHidden(this);
    });
  });
})();
</script>
{% endblock %}
