{% extends 'base.html' %}
{% load form_extras %}
{% block content %}
<div class="row mt-2">
  <div class="col s12 m10 l9">
    <div class="card">
      <div class="card-content">
        <span class="card-title">
          <i class="material-icons left">add_circle</i>Nuovo Ticket
        </span>

        <form method="post" enctype="multipart/form-data" class="row" novalidate>
          {% csrf_token %}
          {{ form.non_field_errors }}

          <!-- Titolo -->
          <div class="input-field col s12">
            {{ form.title.label_tag }}
            {{ form.title }}
            {% for e in form.title.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <!-- Descrizione -->
          <div class="input-field col s12">
            {{ form.description.label_tag }}
            {{ form.description }}
            {% for e in form.description.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <!-- Reparto -->
          <div class="input-field col s12 m6">
            {{ form.department|add_class:"browser-default" }}
            <label class="active">{{ form.department.label }}</label>
            {% for e in form.department.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <!-- PRIORITÃ€ / IMPATTO / URGENZA / CANALE -->
          <div class="input-field col s12 m6">
            {{ form.priority|add_class:"browser-default" }}
            <label class="active">{{ form.priority.label }}</label>
            {% for e in form.priority.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <div class="input-field col s12 m6">
            {{ form.impact|add_class:"browser-default" }}
            <label class="active">{{ form.impact.label }}</label>
            {% for e in form.impact.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <div class="input-field col s12 m6">
            {{ form.urgency|add_class:"browser-default" }}
            <label class="active">{{ form.urgency.label }}</label>
            {% for e in form.urgency.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          {% if form.source_channel %}
          <div class="input-field col s12 m6">
            {{ form.source_channel|add_class:"browser-default" }}
            <label class="active">{{ form.source_channel.label }}</label>
            {% for e in form.source_channel.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>
          {% endif %}

          <!-- ðŸ‘‡ CATEGORIE ICT (mostra SOLO se reparto = ICT) -->
          {% if form.category %}
          <div id="ict-category-row" class="input-field col s12 m6" style="display:none;">
            <label class="active">{{ form.category.label }}</label>
            {{ form.category|add_class:"browser-default" }}
            {% for e in form.category.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>
          {% endif %}

          {% if form.category_other %}
          <div id="ict-category-other-row" class="input-field col s12 m6" style="display:none;">
            {{ form.category_other.label_tag }}
            {{ form.category_other }}
            {% for e in form.category_other.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>
          {% endif %}

          <!-- Campi testo aggiuntivi -->
          <div class="input-field col s12 m6">
            {{ form.location.label_tag }}
            {{ form.location }}
            {% for e in form.location.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <div class="input-field col s12 m6">
            {{ form.asset_code.label_tag }}
            {{ form.asset_code }}
            {% for e in form.asset_code.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
          </div>

          <!-- Allegati -->
          <div class="col s12 m6">
            <div class="file-field input-field">
              <div class="btn blue darken-3">
                <span><i class="material-icons left">attach_file</i>Allega</span>
                <input type="file" id="id_attachments" name="attachments" multiple>
              </div>
              <div class="file-path-wrapper">
                <input class="file-path validate" type="text" placeholder="PDF/JPG/PNG/XLSX/DOCX/TXT, max 15MB ciascuno">
              </div>
            </div>
            {% for e in form.attachments.errors %}<span class="helper-text red-text">{{ e }}</span>{% endfor %}
            <small class="grey-text">
              Formati consentiti: pdf, jpg, jpeg, png, xlsx, docx, txt.
            </small>
          </div>

          <!-- Azioni -->
          <div class="col s12">
            <div class="row" style="margin-bottom:0;">
              <div class="col s12 m6">
                <a href="{% url 'landing' %}" class="btn-flat btn-flat-primary">
                  <i class="material-icons left">arrow_back</i>Annulla
                </a>
              </div>
              <div class="col s12 m6 right-align">
                <button class="btn waves-effect waves-light blue darken-3 btn-full-sm" type="submit">
                  Crea Ticket <i class="material-icons right">send</i>
                </button>
              </div>
            </div>
          </div>

        </form>

      </div>
    </div>
  </div>
</div>

<!-- JS: mostra le categorie solo se reparto = ICT; mostra "Altro" quando selezionato -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const depSel   = document.getElementById('id_department');
  const catRow   = document.getElementById('ict-category-row');
  const otherRow = document.getElementById('ict-category-other-row');
  const catSel   = document.getElementById('id_category');
  const catOther = document.getElementById('id_category_other');

  // Passato dalla view: id del reparto ICT (o null se non trovato)
  const ICT_DEP_ID = {{ ict_dep_id|default:"null" }};

  function isICTSelected() {
    if (!depSel) return false;
    const val = depSel.value;
    if (ICT_DEP_ID !== null) {
      return String(val) === String(ICT_DEP_ID);
    }
    // fallback se non passi ict_dep_id: prova a riconoscere dal testo dell'opzione
    const opt = depSel.options[depSel.selectedIndex];
    return opt && opt.text && opt.text.trim().toUpperCase().startsWith('ICT');
  }

  function sync() {
    const showICT = isICTSelected();

    if (catRow) catRow.style.display = showICT ? '' : 'none';
    if (catSel) {
      catSel.disabled = !showICT;
      if (!showICT) {
        catSel.value = '';
      }
    }

    const isOther = showICT && catSel && catSel.value === 'OTHER';
    if (otherRow) otherRow.style.display = isOther ? '' : 'none';
    if (catOther) {
      catOther.disabled = !isOther;
      if (!isOther) {
        catOther.value = '';
      }
    }
  }

  if (depSel)  depSel.addEventListener('change', sync);
  if (catSel)  catSel.addEventListener('change', sync);

  // Prima sync per stato iniziale (utile dopo validation errors)
  sync();
});
</script>
{% endblock %}
