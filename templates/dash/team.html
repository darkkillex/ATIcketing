{% extends 'base.html' %}
{% load querystring %}
{% load url_utils %}
{% block content %}

<div class="table-title">
    <i class="material-icons blue-text text-darken-2">dashboard</i>
    <h5 class="blue-text text-darken-2" style="margin:0;">Ticket di tutti i reparti</h5>
</div>

<!-- FILTRI -->
<div class="card">
    <div class="card-content">
        <form method="get" class="row" novalidate>
            <!-- Ricerca testo -->
            <div class="input-field col s12 m6 l3">
                {{ filter_form.q.label_tag }}{{ filter_form.q }}
            </div>

            <!-- Select (class=browser-default già impostata in forms.py) -->
            <div class="col s12 m6 l3">
                <label class="active">{{ filter_form.status.label }}</label>
                {{ filter_form.status }}
            </div>
            <div class="col s12 m6 l3">
                <label class="active">{{ filter_form.priority.label }}</label>
                {{ filter_form.priority }}
            </div>
            <div class="col s12 m6 l3">
                <label class="active">{{ filter_form.department.label }}</label>
                {{ filter_form.department }}
            </div>
            <!-- Categoria (si popola in base al reparto) -->
            <div class="col s12 m6 l3">
              <label class="active">Categoria</label>
              <select id="id_category" name="category" class="browser-default">
                <option value="">Tutte</option>
                <!-- le option vengono inserite via JS -->
              </select>
            </div>
            <!-- Dettaglio “Altro” -->
            <div class="input-field col s12 m6 l3" id="flt_category_other_wrap" style="display:none;">
              <input type="text"
                     id="id_category_other"
                     name="category_other"
                     class="validate"
                     placeholder="Specifica se scegli 'Altro'"
                     value="{{ request.GET.category_other|default:'' }}">
              <label for="id_category_other" class="active">Dettaglio (se Altro)</label>
            </div>
            <!-- Date -->
            <div class="input-field col s12 m6 l3">
                {{ filter_form.date_from }}
                <label for="{{ filter_form.date_from.id_for_label }}" class="active">Dal</label>
            </div>
            <div class="input-field col s12 m6 l3">
                {{ filter_form.date_to }}
                <label for="{{ filter_form.date_to.id_for_label }}" class="active">Al</label>
            </div>

            <!-- Page size -->
            <div class="col s12 m6 l3">
                <label class="active">{{ filter_form.page_size.label }}</label>
                {{ filter_form.page_size }}
            </div>

            <!-- Solo miei (solo per team) -->
            {% if filter_form.mine_only %}
            <div class="col s12 m6 l3" style="margin-top:20px;">
                <label>
                    {{ filter_form.mine_only }} <span>Solo miei</span>
                </label>
            </div>
            {% endif %}

            <!-- Azioni -->
            <div class="col s12 right-align">
                <a class="btn-flat" href="."><i class="material-icons left">refresh</i>Reset</a>
                <a class="btn grey darken-2" href="{% url 'team_export_csv' %}{% url_replace %}">
                    <i class="material-icons left">file_download</i>CSV
                </a>
                <button class="btn waves-effect waves-light blue darken-3 btn-full-sm" type="submit">
                    <i class="material-icons left">filter_list</i>Filtra
                </button>
            </div>
                        {# Dati dal server per popolare le categorie #}
            {{ category_map|json_script:"category-map" }}
            {{ dep_code_by_id|json_script:"dep-code-by-id" }}

            <script>
            (function () {
              const depSelect   = document.getElementById('id_department');
              const catSelect   = document.getElementById('id_category');
              const otherWrap   = document.getElementById('flt_category_other_wrap');
              const otherInput  = document.getElementById('id_category_other');

              const categoryMap = JSON.parse(document.getElementById('category-map').textContent);   // {ICT:[[val,label],...], WH:[...], SP:[...]}
              const depCodeById = JSON.parse(document.getElementById('dep-code-by-id').textContent); // {"3":"ICT","7":"WH",...}
              const OTHER_CODE  = "{{ OTHER_CODE }}";
              const preSelCategory = "{{ request.GET.category|default:'' }}";

              function renderCategoryOptions(depId) {
                // svuota select
                while (catSelect.firstChild) catSelect.removeChild(catSelect.firstChild);

                // opzione "Tutte"
                const optAll = document.createElement('option');
                optAll.value = "";
                optAll.textContent = "Tutte";
                catSelect.appendChild(optAll);

                // trova codice reparto e relative scelte
                const depCode = depId ? depCodeById[String(depId)] : null;
                const choices = depCode && categoryMap[depCode] ? categoryMap[depCode] : [];

                // aggiungi opzioni
                choices.forEach(([value, label]) => {
                  const opt = document.createElement('option');
                  opt.value = value;
                  opt.textContent = label;
                  catSelect.appendChild(opt);
                });

                // ripristina selezione da querystring se coerente
                if (preSelCategory) {
                  const found = Array.from(catSelect.options).find(o => o.value === preSelCategory);
                  catSelect.value = found ? preSelCategory : "";
                } else {
                  catSelect.value = "";
                }

                toggleOther(catSelect.value);
              }

              function toggleOther(value) {
                if (value === OTHER_CODE) {
                  otherWrap.style.display = "";
                } else {
                  otherWrap.style.display = "none";
                  if (otherInput) otherInput.value = "";
                }
              }

              // init (carica categorie in base al reparto corrente)
              renderCategoryOptions(depSelect ? depSelect.value : null);

              // eventi
              if (depSelect) {
                depSelect.addEventListener('change', function () {
                  renderCategoryOptions(this.value);   // aggiorna subito senza submit
                });
              }
              if (catSelect) {
                catSelect.addEventListener('change', function () {
                  toggleOther(this.value);
                });
              }
            })();
            </script>
        </form>
        <script>
        (function(){
          const sel = document.getElementById("id_category");
          const wrap = document.getElementById("flt_category_other_wrap");
          const OTHER = "{{ OTHER_CODE }}";
          function toggle(){ wrap.style.display = (sel && sel.value === OTHER) ? "" : "none"; }
          if (sel) { sel.addEventListener("change", toggle); toggle(); }
        })();
        </script>
    </div>
</div>


<!-- TABELLA -->
<div class="card">
    <div class="card-content">
        <div class="responsive-table">
            <table class="highlight striped">
                <thead>
                <tr>
                    <th style="white-space:nowrap;">Protocollo</th>
                    <th>Titolo</th>
                    <th>Comparto</th>
                    <th>Priorità</th>
                    <th>Creato da</th>
                    <th style="white-space:nowrap;">Creato il</th>
                </tr>
                </thead>
                <tbody>
                {% for t in tickets %}
                <tr>
                    <td style="white-space:nowrap;">
                        <a class="chip small" href="{% url 'ticket_detail' t.pk %}">{{ t.protocol }}</a>
                    </td>
                    <td class="truncate" title="{{ t.title }}">
                        <a href="{% url 'ticket_detail' t.pk %}">{{ t.title }}</a>
                    </td>
                    <td><span class="chip">{{ t.department.code }}</span></td>
                    <td>
                        {% if t.priority == 'LOW' %}
                        <span class="chip green lighten-2">Bassa</span>
                        {% elif t.priority == 'MED' %}
                        <span class="chip amber lighten-2">Media</span>
                        {% elif t.priority == 'HIGH' %}
                        <span class="chip deep-orange lighten-2">Alta</span>
                        {% else %}
                        <span class="chip red lighten-2">Bloccante</span>
                        {% endif %}
                    </td>
                    <td>{{ t.created_by.username }}</td>
                    <td style="white-space:nowrap;">{{ t.created_at|date:"d/m/Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="grey-text center-align">Nessun ticket trovato.</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- PAGINAZIONE -->
<div class="card-action center">
    <ul class="pagination">
        {% if page_obj.has_previous %}
        <li class="waves-effect"><a href="{% url_replace page=page_obj.previous_page_number %}"><i
                class="material-icons">chevron_left</i></a></li>
        {% else %}
        <li class="disabled"><a href="#!"><i class="material-icons">chevron_left</i></a></li>
        {% endif %}

        <li class="active blue darken-3"><a href="#!">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</a></li>

        {% if page_obj.has_next %}
        <li class="waves-effect"><a href="{% url_replace page=page_obj.next_page_number %}"><i class="material-icons">chevron_right</i></a>
        </li>
        {% else %}
        <li class="disabled"><a href="#!"><i class="material-icons">chevron_right</i></a></li>
        {% endif %}
    </ul>
</div>
</div>
{% endblock %}
